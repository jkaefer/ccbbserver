{% extends "intronbase.html" %}

{% block content %}

  
  <script>
  var query_id = "{{query_id}}";
  var data_file = "app/allJobs/Intronjob_" + query_id + "/output/snp.prediction.json";
  $(document).ready(function() {
	$.fn.dataTable.ext.errMode = 'throw';
    $('#resultTable').DataTable( {
	    "processing": true,
        "scrollX": true,
		"ajax": data_file,
        "columns": [
            { "data": "#chrom" },
            { "data": "pos" },
            { "data": "ref" },
            { "data": "alt" },
            { "data": "disease" },
            { "data": "prob",
              "render": function ( data, type, row ) {
                 return parseFloat(data).toFixed(2);;
              }
            },
            { "data": "tpr",
              "render": function ( data, type, row ) {
                 return parseFloat(data).toFixed(2);;
              }
            },
            { "data": "fpr",
              "render": function ( data, type, row ) {
                 return parseFloat(data).toFixed(2);;
              }
            },
            { "data": "splicing_site" },
            { "data": "name" },
            { "data": "strand" }
        ]
    } );
    
    var table = $('#resultTable').DataTable();

    $('#resultTable tbody').on( 'click', 'tr', function () {
        if ( $(this).hasClass('info') ) {
            $(this).removeClass('info');
        }
        else {
            table.$('tr.info').removeClass('info');
            $(this).addClass('info');
		}
		var record = table.row(this).data();
        console.log(record['#chrom'].substring(3));
        browser.setLocation(record['#chrom'].substring(3), record['pos'] - 50, record['pos'] + 50);
    } );

    var browser =  new Browser({
      chr:          '22',
      viewStart:    30700000,
      viewEnd:      30900000,

      coordSystem: {
        speciesName: 'Human',
        taxon: 9606,
        auth: 'GRCh',
        version: '37',
        ucscName: 'hg19'
      },

      sources:     [{name:                 'Genome',
                     twoBitURI:            '//www.biodalliance.org/datasets/hg19.2bit',
                     tier_type:            'sequence'},
                    {name:                 'Genes',
                     desc:                 'Gene structures from GENCODE 19',
                     bwgURI:               '//www.biodalliance.org/datasets/gencode.bb',
                     stylesheet_uri:       '//www.biodalliance.org/stylesheets/gencode.xml',
                     collapseSuperGroups:  true,
                     trixURI:              '//www.biodalliance.org/datasets/geneIndex.ix'},
                    {name:                 'Repeats',
                     desc:                 'Repeat annotation from Ensembl',
                     bwgURI:               '//www.biodalliance.org/datasets/repeats.bb',
                     stylesheet_uri:       '//www.biodalliance.org/stylesheets/bb-repeats.xml'},
                    {name:                 'Conservation',
                     desc:                 'Conservation', 
                     bwgURI:               'app/regsnp-intron/annotation/hg19.100way.phyloP100way.bw',
                     noDownsample:         true}],

    });


  } );
  $(function(){
    $.ajax({
      type: 'HEAD',
      url: data_file,
      success: function() {
        $("#message").addClass("alert-success").html("<strong>The full result with all the features can be downloaded here: <a download href='" + "app/allJobs/Intronjob_" + query_id + "/output/snp.prediction.txt" + "' target='_blank'>snp.prediction.txt</a>.</strong>");
      },
      error: function() {
        $("#message").addClass("alert-danger").html("<strong>The job may still be running or an error has occurred. Please check the <a href='intronRes?query_id=" + query_id + "'>submission page</a>.</strong>");
      }
    });
  });
  </script>

  
      <div class="col-sm-9">
		<h1>regSNP-intron</h1>
		<!-- <p id="message"></p> -->
		<div id="message" class="alert"></div>

        </p>
        <table id="resultTable" class="table table-striped table-bordered table-hover" cellspacing="0" width="100%">
          <thead>
              <tr>
                  <th>Chrom</th>
                  <th>Pos</th>
                  <th>Ref</th>
                  <th>Alt</th>
                  <th>Disease</th>
		  <th>Prob</th>
                  <th>TPR</th>
                  <th>FPR</th>
                  <th>Splicing_site</th>
                  <th>Name</th>
                  <th>Strand</th>
              </tr>
          </thead>
        </table>
        <div id="svgHolder" ></div>
        </div
      
  
{% endblock %}
